---
- name: Check Postgre SQL Trigger
  hosts: all
  become: true
  become_method: sudo
  become_user: postgres
  gather_facts: false
  tasks:
    - name: Check for trigger in pg_trigger
      become: false
      shell: |
        PGPASSWORD="redhat123" psql -h {{db_host}} -U {{db_name}} -d {{db_name}} -c "\d+ queue.message1" -P pager=off
      register: trigger_check
    
    - name: Fail if trigger is missing
      fail:
        msg: "Trigger 'new_message_notify()' is missing!"
      when: trigger_check.stdout | int == 0
